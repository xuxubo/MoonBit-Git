#include <stdio.h>
#include <stdlib.h>
#include "git.c" // å‡è®¾ä½ å®šä¹‰çš„ libgit2 å°è£…å‡½æ•°éƒ½åœ¨ git.c é‡Œ

int main()
{
    const char *url = "https://github.com/xxxxxx/xxxxxxxxx.git";
    const char *dir = "test_clone";

    printf("ğŸš€ Cloning repo from %s ...\n", url);
    void *repo = mb_git_clone(url, dir);
    if (!repo)
    {
        printf("âŒ Clone failed\n");
        return 1;
    }
    printf("âœ… Cloned repo pointer: %p\n", repo);

    // ===== å†™å…¥ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ =====
    char file_path[256];
    snprintf(file_path, sizeof(file_path), "%s/test_file.md", dir);
    FILE *fp = fopen(file_path, "w");
    if (!fp)
    {
        perror("âŒ Failed to write test file");
        mb_git_free(repo);
        return 1;
    }
    fprintf(fp, "# Test Commit from C\n\nThis file was generated by libgit2 test.\n");
    fclose(fp);
    printf("âœ… Wrote test file: %s\n", file_path);

    // ===== æ·»åŠ æ–‡ä»¶ =====
    printf("ğŸ§© Adding file...\n");
    int add_res = mb_git_add(repo, "test_file.md");
    if (add_res != 0)
    {
        printf("âŒ Add failed: %d\n", add_res);
        mb_git_free(repo);
        return 1;
    }
    printf("âœ… File added.\n");

    // ===== æäº¤ =====
    printf("ğŸª¶ Committing...\n");
    int commit_res = mb_git_commit(repo, "Test commit from C using libgit2");
    if (commit_res != 0)
    {
        printf("âŒ Commit failed: %d\n", commit_res);
        mb_git_free(repo);
        return 1;
    }
    printf("âœ… Commit success.\n");

    // ===== æ¨é€ =====
    const char *token = "ghp_2xxxxxxxxxxxxxxxxxxxxxxxxxx"; // âš ï¸ ç¡®ä¿æ˜¯æœ‰æ•ˆ token
    printf("ğŸš€ Pushing to GitHub...\n");

    int push_res = mb_git_push(repo, "origin", token);
    if (push_res == 0)
    {
        printf("âœ… Push success!\n");
    }
    else
    {
        printf("âŒ Push failed, code=%d\n", push_res);
    }

    // ===== æ¸…ç† =====
    printf("ğŸ§¹ Freeing repo...\n");
    mb_git_free(repo);
    printf("âœ… Done.\n");

    return 0;
}
